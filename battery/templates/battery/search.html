{% extends 'base/base.html' %}
{% load static %}

{% block title %}电池搜索 - 新能源电池管理系统{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'js/bootstrap-3.4.1-dist/css/bootstrap.min.css' %}">
<style>
  body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    font-family: 'Microsoft YaHei', Helvetica, Arial, sans-serif;
  }

  .search-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 40px 0;
    margin-bottom: 30px;
    text-align: center;
  }

  .search-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 10px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .search-subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
  }

  .search-form-card {
    background: white;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
  }

  .form-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
    margin-bottom: 25px;
    text-align: center;
  }

  .search-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    align-items: end;
  }

  .form-group {
    margin-bottom: 0;
  }

  .form-group label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
    display: block;
  }

  .form-control {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 1rem;
    transition: all 0.3s ease;
  }

  .form-control:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
  }

  .btn-search {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 12px 25px;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s ease;
    height: fit-content;
  }

  .btn-search:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .search-results {
    margin-bottom: 30px;
  }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .results-count {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
  }

  .results-sort {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .results-sort label {
    font-weight: 600;
    color: #666;
    margin: 0;
  }

  .battery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 40px;
  }

  .battery-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    border: 1px solid #f0f0f0;
  }

  .battery-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
  }

  .battery-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .battery-card:hover .battery-image {
    transform: scale(1.05);
  }

  .battery-info {
    padding: 20px;
  }

  .battery-name {
    font-size: 1.2rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 10px;
    line-height: 1.4;
  }

  .battery-specs {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
    line-height: 1.5;
  }

  .battery-price {
    font-size: 1.4rem;
    font-weight: 700;
    color: #e74c3c;
    margin-bottom: 15px;
  }

  .battery-price .currency {
    font-size: 0.9rem;
    color: #999;
  }

  .battery-actions {
    display: flex;
    gap: 10px;
  }

  .btn-detail {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    flex: 1;
    text-decoration: none;
    text-align: center;
  }

  .btn-detail:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
    text-decoration: none;
  }

  .btn-rent {
    background: linear-gradient(45deg, #ff6b6b, #ee5a24);
    border: none;
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    flex: 1;
    text-decoration: none;
    text-align: center;
  }

  .btn-rent:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
    color: white;
    text-decoration: none;
  }

  .status-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-available {
    background: #27ae60;
    color: white;
  }

  .status-rented {
    background: #e74c3c;
    color: white;
  }

  .status-maintenance {
    background: #f39c12;
    color: white;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }

  .empty-state i {
    font-size: 4rem;
    color: #ddd;
    margin-bottom: 20px;
  }

  .pagination {
    margin-top: 40px;
    text-align: center;
  }

  .pagination .page-link {
    color: #667eea;
    border-color: #667eea;
    margin: 0 2px;
    border-radius: 8px;
  }

  .pagination .page-item.active .page-link {
    background-color: #667eea;
    border-color: #667eea;
  }

  .search-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .search-tag {
    background: #f8f9fa;
    color: #333;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9rem;
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .search-tag:hover {
    background: #667eea;
    color: white;
    text-decoration: none;
  }

  @media (max-width: 768px) {
    .search-form {
      grid-template-columns: 1fr;
    }

    .battery-grid {
      grid-template-columns: 1fr;
    }

    .battery-actions {
      flex-direction: column;
    }

    .results-header {
      flex-direction: column;
      gap: 15px;
    }
  }
</style>
{% endblock %}

{% block main %}
<!-- 搜索页面头部 -->
<div class="search-header">
  <div class="container">
    <h1 class="search-title">电池搜索</h1>
    <p class="search-subtitle">找到最适合您需求的新能源电池</p>
  </div>
</div>

<div class="container">
  <!-- 搜索表单 -->
  <div class="search-form-card">
    <h2 class="form-title">
      <i class="glyphicon glyphicon-search"></i> 高级搜索
    </h2>

    <form method="get" class="search-form">
      <div class="form-group">
        <label for="{{ form.search.id_for_label }}">搜索关键词</label>
        {{ form.search }}
      </div>

      <div class="form-group">
        <label for="{{ form.category.id_for_label }}">电池分类</label>
        {{ form.category }}
      </div>

      <div class="form-group">
        <label for="{{ form.min_price.id_for_label }}">最低价格</label>
        {{ form.min_price }}
      </div>

      <div class="form-group">
        <label for="{{ form.max_price.id_for_label }}">最高价格</label>
        {{ form.max_price }}
      </div>

      <div class="form-group">
        <button type="submit" class="btn btn-search">
          <i class="glyphicon glyphicon-search"></i> 搜索
        </button>
      </div>
    </form>
  </div>

  <!-- 搜索结果 -->
  {% if page_obj %}
  <div class="search-results">
    <div class="results-header">
      <div class="results-count">
        找到 {{ page_obj.paginator.count }} 个相关电池
      </div>
      <div class="results-sort">
        <label>排序方式：</label>
        <select class="form-control" style="width: auto;">
          <option>最新发布</option>
          <option>价格从低到高</option>
          <option>价格从高到低</option>
          <option>名称A-Z</option>
        </select>
      </div>
    </div>

    <!-- 搜索标签 -->
    {% if form.search.value or form.category.value or form.min_price.value or form.max_price.value %}
    <div class="search-tags">
      <span>当前筛选：</span>
      {% if form.search.value %}
      <a href="?{% if form.category.value %}category={{ form.category.value }}&{% endif %}{% if form.min_price.value %}min_price={{ form.min_price.value }}&{% endif %}{% if form.max_price.value %}max_price={{ form.max_price.value }}&{% endif %}"
        class="search-tag">
        关键词: {{ form.search.value }} <i class="glyphicon glyphicon-remove"></i>
      </a>
      {% endif %}
      {% if form.category.value %}
      <a href="?{% if form.search.value %}search={{ form.search.value }}&{% endif %}{% if form.min_price.value %}min_price={{ form.min_price.value }}&{% endif %}{% if form.max_price.value %}max_price={{ form.max_price.value }}&{% endif %}"
        class="search-tag">
        分类: {{ form.category.value }} <i class="glyphicon glyphicon-remove"></i>
      </a>
      {% endif %}
      {% if form.min_price.value or form.max_price.value %}
      <a href="?{% if form.search.value %}search={{ form.search.value }}&{% endif %}{% if form.category.value %}category={{ form.category.value }}&{% endif %}"
        class="search-tag">
        价格筛选 <i class="glyphicon glyphicon-remove"></i>
      </a>
      {% endif %}
      <a href="{% url 'battery:search' %}" class="search-tag" style="background: #e74c3c; color: white;">
        清除所有筛选
      </a>
    </div>
    {% endif %}

    <div class="battery-grid">
      {% for battery in page_obj %}
      <div class="battery-card">
        <div class="position-relative">
          <img src="{{ battery.image_url }}" alt="{{ battery.name }}" class="battery-image">
          <span class="status-badge status-{{ battery.status }}">
            {% if battery.status == 'available' %}可用
            {% elif battery.status == 'rented' %}已租出
            {% elif battery.status == 'maintenance' %}维护中
            {% else %}已退役
            {% endif %}
          </span>
        </div>

        <div class="battery-info">
          <h3 class="battery-name">{{ battery.name }}</h3>
          <div class="battery-specs">
            <p><strong>类型：</strong>{{ battery.battery_type.name }}</p>
            <p><strong>规格：</strong>{{ battery.full_specs }}</p>
            <p><strong>重量：</strong>{{ battery.weight }}kg</p>
            <p><strong>位置：</strong>{{ battery.location }}</p>
          </div>

          <div class="battery-price">
            ¥{{ battery.daily_rental_price }}<span class="currency">/天</span>
          </div>

          <div class="battery-actions">
            <a href="{% url 'battery:detail' battery.id %}" class="btn-detail">
              <i class="glyphicon glyphicon-eye-open"></i> 查看详情
            </a>
            {% if battery.is_available %}
            <a href="{% url 'battery:rent' battery.id %}" class="btn-rent">
              <i class="glyphicon glyphicon-shopping-cart"></i> 立即租赁
            </a>
            {% else %}
            <button class="btn-rent" disabled>
              <i class="glyphicon glyphicon-ban-circle"></i> 不可租赁
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- 分页 -->
    {% if page_obj.has_other_pages %}
    <div class="pagination">
      <nav aria-label="搜索结果分页">
        <ul class="pagination">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
              href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">首页</a>
          </li>
          <li class="page-item">
            <a class="page-link"
              href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">上一页</a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
          <li class="page-item active">
            <span class="page-link">{{ num }}</span>
          </li>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <li class="page-item">
            <a class="page-link"
              href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">{{
              num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link"
                href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">下一页</a>
            </li>
            <li class="page-item">
              <a class="page-link"
                href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.min_price %}&min_price={{ request.GET.min_price }}{% endif %}{% if request.GET.max_price %}&max_price={{ request.GET.max_price }}{% endif %}">末页</a>
            </li>
            {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}

  </div>

  {% else %}
  <!-- 空状态 -->
  <div class="empty-state">
    <i class="glyphicon glyphicon-search"></i>
    <h3>未找到相关电池</h3>
    <p>请尝试调整搜索条件或浏览所有电池</p>
    <a href="{% url 'battery:list' %}" class="btn btn-primary">
      <i class="glyphicon glyphicon-flash"></i> 浏览所有电池
    </a>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
  $(document).ready(function () {
    // 电池卡片悬停效果
    $('.battery-card').hover(
      function () {
        $(this).find('.battery-image').css('transform', 'scale(1.05)');
      },
      function () {
        $(this).find('.battery-image').css('transform', 'scale(1)');
      }
    );

    // 搜索标签点击效果
    $('.search-tag').on('click', function () {
      if ($(this).hasClass('search-tag')) {
        // 这里可以添加清除筛选的逻辑
      }
    });

    // 排序功能
    $('.results-sort select').on('change', function () {
      var sortBy = $(this).val();
      var currentUrl = new URL(window.location);
      currentUrl.searchParams.set('sort', sortBy);
      window.location.href = currentUrl.toString();
    });
  });
</script>
{% endblock %}