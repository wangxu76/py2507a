{% extends 'base/base.html' %}
{% load static %}

{% block title %}{{ station.name }} - 网点详情{% endblock %}

{% block css %}
<link rel="stylesheet" href="{% static 'js/bootstrap-3.4.1-dist/css/bootstrap.min.css' %}">
<style>
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Microsoft YaHei', Helvetica, Arial, sans-serif;
    }

    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 30px;
    }

    .station-header {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .station-title {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 15px;
    }

    .station-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .info-item i {
        font-size: 1.5rem;
        color: #667eea;
    }

    .info-item strong {
        color: #333;
    }

    .info-item p {
        margin: 0;
        color: #666;
    }

    .map-container {
        background: white;
        border-radius: 15px;
        padding: 0;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        height: 400px;
    }

    #stationMap {
        width: 100%;
        height: 100%;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
    }

    .section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
    }

    .battery-item {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }

    .battery-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .battery-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
    }

    .battery-specs {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 15px;
    }

    .battery-price {
        font-size: 1.5rem;
        font-weight: 700;
        color: #e74c3c;
        margin-bottom: 15px;
    }

    .btn-rent {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        color: white;
        padding: 10px 25px;
        border-radius: 25px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-rent:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .status-badge {
        display: inline-block;
        padding: 6px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-available {
        background: #d4edda;
        color: #155724;
    }

    .status-rented {
        background: #f8d7da;
        color: #721c24;
    }

    .history-item {
        border-left: 4px solid #667eea;
        padding: 15px;
        margin-bottom: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .history-date {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }

    .history-info {
        color: #666;
        font-size: 0.9rem;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }

    .empty-state i {
        font-size: 2.5rem;
        color: #ddd;
        margin-bottom: 15px;
    }

    @media (max-width: 768px) {
        .station-info-grid {
            grid-template-columns: 1fr;
        }

        .battery-specs {
            grid-template-columns: 1fr;
        }

        .map-container {
            height: 300px;
        }
    }
</style>
{% endblock %}

{% block main %}
<!-- 页面头部 -->
<div class="page-header">
    <div class="container">
        <h1 style="margin: 0;"><i class="glyphicon glyphicon-map-marker"></i> 网点详情</h1>
    </div>
</div>

<div class="container">
    <!-- 网点信息 -->
    <div class="station-header">
        <h2 class="station-title">{{ station.name }}</h2>
        
        <div class="station-info-grid">
            <div class="info-item">
                <i class="glyphicon glyphicon-home"></i>
                <div>
                    <strong>地址</strong>
                    <p>{{ station.address }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <i class="glyphicon glyphicon-phone"></i>
                <div>
                    <strong>电话</strong>
                    <p><a href="tel:{{ station.phone }}">{{ station.phone }}</a></p>
                </div>
            </div>
            
            <div class="info-item">
                <i class="glyphicon glyphicon-time"></i>
                <div>
                    <strong>营业时间</strong>
                    <p>{{ station.business_hours }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <i class="glyphicon glyphicon-flash"></i>
                <div>
                    <strong>电池库存</strong>
                    <p>{{ station.current_batteries }} / {{ station.max_batteries }}</p>
                </div>
            </div>
            
            <div class="info-item">
                <i class="glyphicon glyphicon-ok"></i>
                <div>
                    <strong>营业状态</strong>
                    <p>{% if station.is_active %}<span class="label label-success">营业中</span>{% else %}<span class="label label-danger">已关闭</span>{% endif %}</p>
                </div>
            </div>
        </div>
        
        {% if station.description %}
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
            <strong>网点说明：</strong> {{ station.description }}
        </div>
        {% endif %}
    </div>

    <!-- 地图 -->
    <div class="map-container">
        <div id="stationMap"></div>
    </div>

    <!-- 可用电池列表 -->
    <div class="section">
        <h3 class="section-title"><i class="glyphicon glyphicon-flash"></i> 可用电池</h3>
        
        {% if available_batteries %}
        <div class="row">
            {% for battery in available_batteries %}
            <div class="col-md-6">
                <div class="battery-item">
                    <div class="battery-name">
                        {{ battery.name }}
                        <span class="status-badge status-available">可用</span>
                    </div>
                    
                    <div class="battery-specs">
                        <div><i class="glyphicon glyphicon-flash"></i> {{ battery.capacity }}Ah</div>
                        <div><i class="glyphicon glyphicon-ok"></i> {{ battery.voltage }}V</div>
                        <div><i class="glyphicon glyphicon-th"></i> {{ battery.power }}W</div>
                    </div>
                    
                    <div class="battery-price">¥{{ battery.daily_rental_price }}/天</div>
                    
                    <form method="post" action="{% url 'station:rent' station.id %}" style="display: inline;">
                        {% csrf_token %}
                        <input type="hidden" name="battery_id" value="{{ battery.id }}">
                        <div class="form-inline">
                            <label>租赁天数：</label>
                            <input type="number" name="rental_days" value="1" min="1" max="30" class="form-control" style="width: 80px; margin-right: 10px;">
                            <button type="submit" class="btn btn-rent">
                                <i class="glyphicon glyphicon-shopping-cart"></i> 租赁
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="glyphicon glyphicon-inbox"></i>
            <p>暂无可用电池</p>
        </div>
        {% endif %}
    </div>

    <!-- 我的租赁记录 -->
    {% if user.is_authenticated %}
    <div class="section">
        <h3 class="section-title"><i class="glyphicon glyphicon-history"></i> 我的租赁记录</h3>
        
        {% if user_rentals %}
        <div>
            {% for rental in user_rentals %}
            <div class="history-item">
                <div class="history-date">
                    {{ rental.battery.name }}
                    <span class="label" style="{% if rental.status == 'completed' %}background: #28a745;{% elif rental.status == 'confirmed' %}background: #ffc107;{% else %}background: #6c757d;{% endif %} color: white; font-size: 0.8rem;">
                        {% if rental.status == 'completed' %}已完成{% elif rental.status == 'confirmed' %}确认中{% else %}待确认{% endif %}
                    </span>
                </div>
                <div class="history-info">
                    租赁时间：{{ rental.rental_date|date:"Y-m-d H:i" }}
                    {% if rental.actual_return_date %}
                    | 归还时间：{{ rental.actual_return_date|date:"Y-m-d H:i" }}
                    {% endif %}
                    | 金额：¥{{ rental.rental_amount }}
                </div>
                
                {% if rental.status == 'confirmed' %}
                <form method="post" action="{% url 'station:return' rental.id %}" style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px;">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>电池状态：</label>
                        <select name="battery_condition" class="form-control" style="max-width: 200px;">
                            <option value="excellent">完好</option>
                            <option value="good" selected>良好</option>
                            <option value="fair">一般</option>
                            <option value="poor">有损坏</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>归还备注：</label>
                        <textarea name="notes" class="form-control" rows="2" placeholder="请输入归还备注"></textarea>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="glyphicon glyphicon-ok"></i> 确认归还
                    </button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <i class="glyphicon glyphicon-inbox"></i>
            <p>暂无租赁记录</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block js %}
<script>
    // 百度地图配置
    var BaiduMapAK = 'CRfAza5WQJ7SOtHWeIBJdlSvMpiZUyhP';  // ✅ 你的 AK
    
    function loadStationMap() {
        var script = document.createElement('script');
        script.src = `https://api.map.baidu.com/api?v=1.0&ak=${BaiduMapAK}&s=1&callback=initStationMap`;
        document.head.appendChild(script);
    }

    function initStationMap() {
        var map = new BMap.Map('stationMap');
        var point = new BMap.Point({{ longitude }}, {{ latitude }});
        
        map.centerAndZoom(point, 16);
        map.addControl(new BMap.NavigationControl());
        map.addControl(new BMap.ScaleControl());
        map.enableScrollWheelZoom(true);
        
        // 添加网点标记
        var marker = new BMap.Marker(point);
        map.addOverlay(marker);
        
        // 创建信息窗口
        var opts = {
            width: 300,
            height: 100
        };
        var infoWindow = new BMap.InfoWindow(
            `<div style="padding: 10px;">
                <h4>{{ station.name }}</h4>
                <p>{{ station.address }}</p>
                <p><strong>电话：</strong> {{ station.phone }}</p>
            </div>`,
            opts
        );
        
        marker.addEventListener('click', function() {
            map.openInfoWindow(infoWindow, point);
        });
        
        map.openInfoWindow(infoWindow, point);
    }

    window.addEventListener('load', function() {
        loadStationMap();
    });
</script>
{% endblock %}
